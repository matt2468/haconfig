<dom-module id='ha-panel-alarm'>
    <style include="ha-style iron-flex iron-flex-factors">
      app-header-layout {
        background-color: #E5E5E5;
      }

      .content {
        padding: 15px;
      }

      :host ::content .badge-container.ha-label-badge {
        margin-left: 16px;
        margin-bottom: 0px;
      }

      .actions {
        margin-left: 20px;
        @apply(--layout-self-center);
      }

      .box {
        max-width: 350px;
        border-radius: 3px;
        background-color: white;
        margin-bottom: 10px;
        padding: 15px;

        @apply(--shadow-elevation-4dp);
        opacity: var(--dark-primary-opacity);
      }

      .title {
        @apply(--paper-font-headline);
        margin: 10px;
      }
    </style>

    <template>
      <app-header-layout has-scrolling-region>
        <app-header fixed>
            <app-toolbar>
                <ha-menu-button narrow='[[narrow]]' show-menu='[[showMenu]]'></ha-menu-button>
                <div main-title>Alarm</div>
            </app-toolbar>
        </app-header>

        <div class='content'>
        <div class='box horizontal layout'>
          <ha-state-label-badge hass='[[hass]]' state='[[alarm]]'></ha-state-label-badge>
          <div class='actions'>
            <template is='dom-if' if='[[isdisarmed(alarm)]]'>
                <paper-button on-tap='armhome' raised>Arm Home</paper-button>
                <paper-button on-tap='armaway' raised>Arm Away</paper-button>
            </template>
            <template is='dom-if' if='[[!isdisarmed(alarm)]]'>
                <paper-button on-tap='disarm' raised>Disarm</paper-button>
            </template>
          </div>
        </div>

        <div class='box'>
          <div class='title'>Inactive Sensors</div>
            <template is='dom-repeat' items='[[signals]]' as='entity'>
              <state-card-display state-obj="[[entity]]" hass='[[hass]]'></state-card-display>
            </template>
          </div>
        </div>
      </app-header-layout>
    </template>
</dom-module>

<script>

Polymer({
  is: 'ha-panel-alarm',
  properties: {
    // things that appear in all the other panels 
    hass:     { type: Object },
    panel:    { type: Object },
    narrow:   { type: Boolean, value: false },
    showMenu: { type: Boolean, value: false },
    // things specific to this alarm panel
    alarm:    { type: Object },
    signals:  { type: Array },
    armed:    { type: Array },
    // Hold our unobservers
    cleanup:  { type: Array, value: [] },
  },

  observers: [ 'updateAlarm(hass, panel)' ],
  isdisarmed: function(alarm) { return alarm.state == "disarmed"; },
  docall:    function(action) { this.hass.serviceActions.callService('alarm_control_panel', action, {'entity_id': this.alarm.entityId})},

  armaway: function() { this.docall('alarm_arm_away'); },
  armhome: function() { this.docall('alarm_arm_home'); },
  disarm:  function() { this.docall('alarm_disarm');   },

  // Polymer gaurantees that this won't bet called util hass and panel are both defined
  updateAlarm: function(hass, panel) {
    alarmgetter  = this.hass.entityGetters.byId(panel.config.alarmid);
    this.alarm = hass.reactor.evaluate(alarmgetter);
    this.cleanup.push(hass.reactor.observe(alarmgetter, function(val) { this.alarm = val; }.bind(this)));

    signalgetter = [  this.hass.entityGetters.entityMap, 
          function(map) { return map.valueSeq().filter(x => this.alarm.attributes.listento.indexOf(x.entityId) > -1).toArray(); }.bind(this)]
    this.signals = this.hass.reactor.evaluate(signalgetter);
    this.cleanup.push(hass.reactor.observe(signalgetter, function(val) { this.signals = val; }.bind(this)));
  },

  detached: function() {
    this.cleanup.forEach(func => func());
    this.cleanup = [];
  }
});
</script>

